#!/bin/bash -e

# jemalloc（メモリ使用量とレイテンシ改善）の有効化
if [ -z "${LD_PRELOAD+x}" ]; then
  LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
  export LD_PRELOAD
fi

# まず現在のPATHを確認
echo "DEBUG: (Entrypoint) Initial PATH: $PATH"

# RubyのバージョンからBundlerのbinディレクトリパスを動的に取得
RUBY_BUNDLE_BIN_DIR="/rails/vendor/bundle/ruby/$(ruby -e 'puts RUBY_VERSION[0..2] + ".0"')/bin"
echo "DEBUG: (Entrypoint) Calculated RUBY_BUNDLE_BIN_DIR: $RUBY_BUNDLE_BIN_DIR"

# そのパスが実際に存在し、実行可能なファイルがあるかを確認
if [ -d "$RUBY_BUNDLE_BIN_DIR" ]; then
  echo "DEBUG: (Entrypoint) $RUBY_BUNDLE_BIN_DIR exists."
  ls -la "$RUBY_BUNDLE_BIN_DIR"
else
  echo "ERROR: (Entrypoint) $RUBY_BUNDLE_BIN_DIR does NOT exist!"
fi

# # 更新されたPATHで 'rails' コマンドが見つかるか確認
# if command -v rails; then
#   echo "DEBUG: (Entrypoint) 'rails' command found in PATH!"
# else
#   echo "ERROR: (Entrypoint) 'rails' command NOT found in PATH after update!"
#   echo "Attempting to find bundle exec rails directly:"
#   find /rails -name rails -executable -print -quit
#   # これでも見つからない場合、問題は非常に深刻
# fi

# 条件分岐をやめて、常に DB の準備を実行する
echo "⛏ Running: rails db:prepare..."
bundle exec rails db:prepare

exec "$@"
