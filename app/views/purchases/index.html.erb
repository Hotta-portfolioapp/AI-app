<div class="container-fluid">
  <div class="row min-vh-100">

    <!-- ✅ 左カラム：サイドメニュー -->
    <div class="col-md-3 p-4 border-end">
      <% menu_items = [
        { text: "プロフィールを編集する", path: edit_user_path(current_user) },
        { text: "アカウントを編集する", path: edit_user_registration_path },
        { text: "投稿一覧", path: user_path },
        { text: "お支払い情報", path: payment_path },
      ] %>

      <% menu_items.each do |item| %>
        <div class="p-3 mb-3 border rounded shadow-sm bg-white menu-box">
          <%= link_to item[:text], item[:path], class: "text-decoration-none text-dark fw-bold d-block" %>
        </div>
      <% end %>
    </div>

    <!-- ✅ 右カラム：購入履歴カード -->
    <div class="col-md-9 p-4">
      <h2 class="fw-bold mb-4 text-center">購入履歴</h2>

      <% if @purchases.any? %>
        <div class="row row-cols-2 row-cols-md-3 row-cols-xl-4 g-3">
          <% @purchases.each do |purchase| %>
            <% knowhow = purchase.knowhow %>
            <div class="col">
              <div class="card h-100 shadow-sm overflow-hidden position-relative">

                <!-- カード全体をリンク -->
                <%= link_to knowhow_path(knowhow), class: "stretched-link" do %><% end %>

                <% if knowhow.media_files.attached? %>
                  <% primary_file = knowhow.media_files.first %>
                  <% if primary_file.image? %>
                    <%= image_tag url_for(primary_file), class: "card-img-top aspect-ratio-16x9", style: "object-fit: cover;" %>
                  <% elsif primary_file.video? %>
                    <video controls class="card-img-top aspect-ratio-16x9" style="object-fit: cover;">
                      <source src="<%= url_for(primary_file) %>" type="<%= primary_file.content_type %>">
                    </video>
                  <% elsif primary_file.audio? %>
                    <div class="p-3">
                      <audio controls class="w-100">
                        <source src="<%= url_for(primary_file) %>" type="<%= primary_file.content_type %>">
                      </audio>
                    </div>
                  <% end %>
                <% end %>

                <div class="card-body d-flex flex-column">
                  <h5 class="card-title fw-bold mb-2"><%= knowhow.title %></h5>
                  <p class="card-text small text-muted description-fixed">
                    <%= knowhow.description %>
                  </p>

                  <div class="mt-auto">
                    <ul class="list-unstyled small mb-2">
                      <li>カテゴリ: <%= t("enum.knowhow.category_type.#{knowhow.category_type}") %></li>
                      <li>価格: ¥<%= knowhow.price %></li>
                      <li>購入日: <%= purchase.created_at.strftime("%Y/%m/%d %H:%M") %></li>
                    </ul>

                    <% if current_user && (knowhow.user_id == current_user.id || knowhow.purchases.exists?(user_id: current_user.id)) %>
                      <%= link_to(
                            "チャットする",
                            chat_room_path(knowhow.chat_room),
                            class: "btn btn-outline-primary btn-sm position-relative z-1",
                            data: { turbo: false }
                          ) %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center mt-5">
          <p>購入履歴はありません。</p>
        </div>
      <% end %>
    </div>

  </div>
</div>
