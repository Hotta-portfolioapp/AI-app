<%= link_to "新規登録", new_knowhow_path, class: "btn btn-primary mb-3" %>

<%= search_form_for @q, url: knowhows_path, method: :get do |f| %>
  <div>
    <%= f.search_field :title_or_description_or_user_name_or_user_email_cont, placeholder: "キーワードや投稿者名で検索" %>
  </div>

  <div>
    <%= f.select :category_type_eq, 
      options_for_select(
        Knowhow.category_types.map { |k, v| [t("enum.knowhow.category_type.#{k}"), v] },
        @q.category_type_eq
      ),
      { include_blank: 'すべて' } %>
  </div>

  <div>
    <%= f.search_field :tags_name_cont, placeholder: "タグで検索" %>
  </div>

  <div>
    <%= f.number_field :price_gteq, placeholder: "最低価格（円）" %>
    <%= f.number_field :price_lteq, placeholder: "最高価格（円）" %>
  </div>

  <div>
    <%= f.submit "検索" %>
  </div>
<% end %>

<div class="knowhows-list mt-4">
  <% @knowhows.each do |knowhow| %>
    <div class="knowhow-card border p-3 mb-4 rounded">
    <h3><%= link_to knowhow.title, knowhow %></h3>
      <% if knowhow.media_files.attached? %>
        <div class="media-scroll-container mb-2">
          <% knowhow.media_files.each do |file| %>
            <div class="media-item">
              <% if file.image? %>
                <%= image_tag url_for(file), class: "img-fluid knowhow-media-image" %>
              <% elsif file.video? %>
                <video controls class="knowhow-media-video">
                  <source src="<%= url_for(file) %>" type="<%= file.content_type %>">
                </video>
              <% elsif file.audio? %>
                <video controls class="knowhow-media-video">
                  <source src="<%= url_for(file) %>" type="<%= file.content_type %>">
                </audio>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <p><%= truncate(knowhow.description, length: 80) %></p>
      <p>カテゴリ: <%= t("enum.knowhow.category_type.#{knowhow.category_type}") %></p>
      <p>価格: ¥<%= knowhow.price %></p>
      <p>投稿者: 
        <%= link_to (knowhow.user.name || knowhow.user.email), knowhows_path(q: { user_name_or_user_email_cont: knowhow.user.name || knowhow.user.email }) %>
      </p>

      <% if knowhow.tags.any? %>
        <p>タグ: 
          <% knowhow.tags.each do |tag| %>
            <%= link_to "##{tag.name}", knowhows_path(q: { tags_name_cont: tag.name }), class: "badge bg-secondary me-1" %>
          <% end %>
        </p>
      <% end %>
    </div>
  <% end %>
</div>
